import { Callout } from "nextra/components";

# 编辑器

## 集成 EditorConfig 配置

在根目录创建`.editorconfig` 文件：

[EditorConfig](https://editorconfig.org) 有助于为不同 IDE 编辑器上处理同一项目的多个开发人员维护一致的代码风格

```.editorconfig
# http://editorconfig.org
root = true

[*]
charset = utf-8
end_of_line = lf
indent_size = 4
indent_style = space
insert_final_newline = true
max_line_length = 120
trim_trailing_whitespace = true

[*.md]
max_line_length = 0
trim_trailing_whitespace = false
```

<Callout type="default">
  VSCode 使用 EditorConfig 需要去插件市场下载插件 EditorConfig VS Code <br />
  JetBrains 系列 （WebStorm、IntelliJ IDEA）则不用额外安装插件，可直接使用 EditorConfig
  配置。
</Callout>

## 代码注释插件

在 VSCode 中添加代码注释：

1. 手动添加：通过快捷键 `Ctrl + /`（Windows/Linux）或 `Cmd + /`（Mac）添加行注释，在选中代码后按下快捷键即可。也可以手动编写注释。
2. 插件：安装[Document This](https://marketplace.visualstudio.com/items?itemName=oouo-diogo-perdigao.docthis)

## 集成 `husky`、`eslint`、`lint-staged`、`commitlint`

### 代码提交流程

1. 待提交的代码 git add 添加到 git 暂存区（staged）
2. 执行 git commit
3. husky 注册在 git hook 中的 pre-commit 钩子函数被调用，执行 lint-staged
4. husky 注册在 git hook 中的 commit-msg 钩子函数被调用，执行 commitlint，强制校验代码提交时的 commit msg
5. lint-staged（只对暂存区文件执行 lint）取得所有被提交的文件依次执行写好的任务（ESLint 和 Prettier）；
6. 如果有错误（没通过 ESlint 检查）则停止任务，同时打印错误信息，等待修复后再执行 commit
7. 成功 commit，可 push 到远程

### 认识流程中的工具

1. `husky`

> 代码检查最理想的时机应该是在本地执行 git commit 时触发代码检查，那么就需要用到 git hook。husky 是一个为 git 客户端增加 hook 的工具。将其安装到所在仓库的过程中它会自动在 .git/ 目录下增加相应的钩子实现

2. `git hook`

> git 的 hook 就是 git add、git commit 等 git 操作时的回调钩子（可以查看.git 文件下的 hooks 目录）

3. `lint-staged`

> 在 pre-commit 钩子函数中执行 lint-staged。在进行 git commit 的时候触发到 git hook 进而执行 pre-commit，而 pre-commit 脚本引用了 lint-staged 配置表，只对 git add 到 stage 区的文件进行配置表中配置的操作

4. `commitlint`

> 使用 commitLint 强制校验代码提交时的 commit msg 格式，约束团队 git 提交规范，方便历史回顾、帮助他人更好 review、查找、追踪代码变动历史等。也需要使用 huksy，将 commitlint 的检查绑定到 commit-msg 这个 hook 上

- 提交类型

```config
test: 测试用例代码
feat: 增加新功能
fix: 修复bug
docs: 仅仅修改了文档等（不是指文案类的改动，而是指项目文档、代码注释等）
style: 代码风格变动，例如空格、缩进等（不是指css文件变动）
refactor: 重构(非fix、非feature、非style风格格式化)
perf: 优化
ci: 项目构建配置的变动
release: 发布新版本
init: 初始化项目
revert: 代码回滚
build: 项目构建打包
log: 仅仅修改了文档等（不是指文案类的改动，而是指项目文档、代码注释等）
chore: 其他类型的更改（非即以上类型的改动）
```

### 安装

```bash
npm install --save-dev husky lint-staged eslint eslint-config-prettier eslint-plugin-node eslint-plugin-react eslint-plugin-react-hooks eslint-plugin-prettier prettier commitlint @commitlint/config-conventional git-cz
```

<Callout type="info">
  `eslint-plugin-node`、`eslint-plugin-react`、`eslint-plugin-react-hooks`
  按项目需要选择安装
</Callout>

### 配置

#### 配置 `eslint`

1. `eslint` 配置文件可以有多种形式，`eslint` 配置文件优先级：

`.eslintrc.js`(输出一个配置对象)
`.eslintrc.yaml`
`.eslintrc.yml`
`.eslintrc.json`（`eslint` 的 JSON 文件允许 JavaScript 风格的注释）
`.eslintrc`（可以是 JSON 也可以是 YAML）
`package.json`（在 package.json 里创建一个 eslintConfig 属性，在那里定义你的配置）

在项目根目录创建一个.eslintignore 文件，告诉 ESLint 去忽略特定的文件和目录
.eslintignore 文件是一个纯文本文件，其中的每一行都是一个 glob 模式表明哪些路径应该忽略检测

```.eslintignore
/build/
/config/
/dist/
/scripts/
```

.eslintrc.js 配置文件：

```js
// https://eslint.org/docs/user-guide/configuring
module.exports = {
  root: true,
  env: {
    "shared-node-browser": true,
    browser: true,
    node: true,
    es2021: true,
  },
  extends: [
    "eslint:recommended",
    "plugin:react/recommended",
    "plugin:node/recommended",
    "plugin:react-hooks/recommended",
    "prettier",
  ],
  parser: "@babel/eslint-parser",
  parserOptions: {
    ecmaFeatures: {
      jsx: true,
    },
    ecmaVersion: 12,
    sourceType: "module",
    requireConfigFile: false,
    babelOptions: {
      presets: ["@babel/preset-react"],
      plugins: ["@babel/plugin-proposal-class-properties"],
    },
  },
  plugins: ["react", "node", "prettier"],
  globals: {
    document: true,
    localStorage: true,
    window: true,
    __dirname: true,
    importScripts: true,
  },
  settings: {
    node: {
      allowModules: ["electron"],
      resolvePaths: [
        __dirname,
        `${__dirname}/src`,
        `${__dirname}/src/11-native`,
      ],
      tryExtensions: [".js", ".json", ".node"],
    },
    "import/resolver": {
      webpack: {
        config: "src/**/yach.webpack.js",
      },
      alias: [["@u", "src/13-im/utils"]],
    },
    react: {
      version: "999.999.999",
    },
  },
  // off或0--关闭规则
  // warn或1--开启规则，警告级别(不会导致程序退出)
  // error或2--开启规则，错误级别(当被触发的时候，程序会退出)
  rules: {
    "node/no-unsupported-features/es-syntax": 0,
    "node/no-extraneous-import": 0,
    "node/no-unsupported-features/node-builtins": 0,
    "node/no-extraneous-require": 0,
    "node/no-deprecated-api": 0,
    "node/no-missing-import": 0,
    "node/no-unpublished-import": 0,
    "node/no-missing-require": 0,
    "node/no-unpublished-require": 0,

    "react/prop-types": 0,
    "react/display-name": 0,
    "react/no-children-prop": 0,
    "react/jsx-no-target-blank": 0,
    "react/no-string-refs": 0,
    "react/no-direct-mutation-state": 0,
    "react/no-find-dom-node": 0,
    "react/jsx-no-duplicate-props": 0,

    quotes: [1, "single"],
    complexity: 0,
    eqeqeq: 0,
    "max-len": 0,
    "no-case-declarations": 0,
    camelcase: 0,
    "no-empty-function": 0,
    "array-bracket-spacing": [2, "never"],
    "comma-spacing": [
      2,
      {
        before: false,
        after: true,
      },
    ],
    "computed-property-spacing": [2, "never"],
    "keyword-spacing": 2,
    "space-before-blocks": [2, "always"],
    "space-in-parens": [2, "never"],
    "space-infix-ops": 2,
    "space-unary-ops": [
      2,
      {
        words: true,
        nonwords: false,
      },
    ],
    "spaced-comment": [
      2,
      "always",
      {
        markers: [
          "global",
          "globals",
          "eslint",
          "eslint-disable",
          "*package",
          "!",
        ],
      },
    ],
    "no-useless-escape": 0,
    "no-undef": 2,
    "no-unused-vars": 0,
    "guard-for-in": 0,
    "no-empty": 0,
    "default-case": 0,
    "no-process-exit": 0,
    "no-prototype-builtins": 0,
    "no-control-regex": 0,
    "no-fallthrough": 0,
    "no-mixed-spaces-and-tabs": 0,
    "no-redeclare": 0,
    "no-inner-declarations": 0,
    "no-irregular-whitespace": 0,
    "prettier/prettier": [
      "error",
      {
        endOfLine: "auto",
      },
    ],
  },
};
```

#### 配置 `prettier`

与 eslint 的配置方式相似，prettier 也可以有多重配置文件

prettier.config.js 配置文件：

```js
module.exports = {
    printWidth: 120, // 每行代码的最大长度，默认80
    tabWidth: 4, // 每个tab代表多少个空格
    useTab": false, // 是否使用tab进行缩进，默认false
    singleQuote: true, 使用单引号，默认false
    semi: true, // 句末加分号，默认true
    trailingComma: "none", // 多行使用拖尾逗号，默认none
    bracketSpacing": true, // 对象字面量的大括号间使用空格，默认true
    jsxBracketSameLine: false, // 多行JSX中的>放置在最后一行的结尾，而不是另起一行，默认false
    arrowParens: "avoid" // 只有一个参数的箭头函数的参数是否带圆括号，默认avoid
};
```

prettier 有 3 种使用方式：

- 在编辑器中安装插件，如`vs code`中安装 `Prettier - Code formatter`；
- 使用命令行脚本，基于根目录配置文件的，使用命令行 `prettier --write {components,src,pages}/**/*.{js,tsx}` 格式化，prettier 不但需要在项目里安装，还需要全局安装才能使用 prettier 命令，否则无效
- 作为 linter 工具的插件使用（也是本方案采取的方式）
  - 由于需要同时使用 prettier 和 eslint，而 prettier 的一些规则和 eslint 的一些规则可能存在冲突，所以需要将 eslint 的一些可能与 prettier 发生冲突的代码格式化规则关闭。这里使用 eslint-plugin-prettier 和 eslint-config-prettier
  - eslint-plugin-prettier 可以将 prettier 的规则设置为 eslint 的规则，对不符合规则的进行提示
  - eslint-config-prettier 可以关闭 eslint 可能与 prettier 发生冲突的代码格式化规则。官方称 eslint-plugin-prettier 需要与 eslint-config-prettier 搭配使用才能获得最佳效果

#### 配置 `commitlint` [传送门](https://segmentfault.com/a/1190000017790694)

```bash
echo "export default {extends: ['@commitlint/config-conventional']};" > commitlint.config.js
```

可以定义[规则](https://commitlint.js.org/reference/rules) 自己扩展配置，如：

```js
const config = {
    rules: {
        'body-leading-blank': [1, 'always'],
        'footer-leading-blank': [1, 'always'],
        'header-max-length': [2, 'always', 72],
        'scope-case': [2, 'always', 'lower-case'],
        'subject-case': [2, 'never', ['sentence-case', 'start-case', 'pascal-case', 'upper-case']],
        'subject-empty': [2, 'never'],
        'subject-full-stop': [2, 'never', '.'],
        'type-case': [2, 'always', 'lower-case'],
        'type-empty': [2, 'never'],
        'type-enum': [2, 'always', {
                chore: {
                    description: 'Build process or auxiliary tool changes',
                    value: 'chore',
                },
                ci: {
                    description: 'CI related changes',
                    value: 'ci',
                },
                docs: {
                    description: 'Documentation only changes',
                    value: 'docs',
                },
                feat: {
                    description: 'A new feature',
                    value: 'feat',
                },
                fix: {
                    description: 'A bug fix',
                    value: 'fix',
                },
                perf: {
                    description: 'A code change that improves performance',
                    value: 'perf',
                },
                refactor: {
                    description: 'A code change that neither fixes a bug or adds a feature',
                    value: 'refactor',
                },
                release: {
                    description: 'Create a release commit',
                    value: 'release',
                },
                style: {
                    description: 'Markup, white-space, formatting, missing semi-colons...',
                    value: 'style',
                },
                test: {
                    description: 'Adding missing tests',
                    value: 'test',
                },
                wip: { value: 'wip', description: 'Work in progress' },
                init: { value: 'init', description: 'Init a project' },
                revert: { value: 'revert', description: 'Revert a commit' },
                log: { value: 'log', description: 'add a log' },
        }],
        'scope-enum': [2, 'always', {
            'components', 'utils', 'constants', 'pages'
        }],
    },
};

module.exports = config;
```

#### 配置`lint-staged` [传送门](https://www.jianshu.com/p/6d5b8a1c8d6c)

lint-staged 的路径按照 glob 规则配置，先 prettier 格式化，再 eslint 检查，最后重新 git add

```json
{
  "scripts": {
    "prepare": "husky install",
    "cz": "npx git-cz"
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "prettier --write --cache",
      "eslint --fix --ignore-path --cache",
      "git add"
    ]
  }
}
```

执行 `yarn cz` 即可完成代码美化、检查、提交信息校验、提交等一系列操作
